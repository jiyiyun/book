1.1.4评估网站性能的专业术语
---

```txt
PV  [Page View]  每个刷新会被计算一次，浏览器发出一个request,会返回一个页面，就产生一个PV 
UV  [Unique Visitor]  如果以天为计量单位，24小时内相同的用户无论访问多少次都只能算一个UV，有时候会产生误差，
                    有的公司通过NAT上网，公网IP就一个，按照IP统计只能算一个UV  
并发连接   同时能提供的连接数
每秒查询率QPS  [Query Per Second] 在规定时间[每秒]内能处理的流量大小

使用服务器的时候记住一个原则，系统安装的应用程序越少，服务器越稳定，服务器单机性能调优，本着稳定安全的原则
，尽量不要改动系统原有配置(CentOS系统自身的文件系统和内存机制就很优秀）

1) 优化yum更新源
安装yum-priorities源优先工具
$yum install yum-priorities

只要编辑对应的repo文件，在文件后面追加
priority=对应的数字
注意要开启yum 源优先功能，确保priorities.conf文件有如下内容
vim /etc/yum/pluginconf.d/priorities.conf
[main]
enable=1

2) 关闭不必要的服务
$ntsysv
列出自动启动的服务，下面是需要启动的服务
crond  自动计划服务
network  网络服务
sshd   OpenSSH服务的守护进程
rsyslog  日志服务

3) 关闭不必要的tty
可以使用vim打开vim /etc/init/start-ttys.conf
[root@localhost ~]# cat /etc/init/start-ttys.conf 
#
# This service starts the configured number of gettys.
#
# Do not edit this file directly. If you want to change the behaviour,
# please create a file start-ttys.override and put your changes there.

start on stopped rc RUNLEVEL=[2345]

env ACTIVE_CONSOLES=/dev/tty[1-6]
env X_TTY=/dev/tty1
task
script
	. /etc/sysconfig/init
	for tty in $(echo $ACTIVE_CONSOLES) ; do
		[ "$RUNLEVEL" = "5" -a "$tty" = "$X_TTY" ] && continue
		initctl start tty TTY=$tty
	done
end script
[root@localhost ~]# 
这段代码打开了6个控制台，这6个都默认驻留在内存中，
[root@localhost ~]# ps -aux|grep tty |grep -v grep
Warning: bad syntax, perhaps a bogus '-'? See /usr/share/doc/procps-3.2.8/FAQ
root      2145  0.0  0.0   4060   544 tty2     Ss+  17:41   0:00 /sbin/mingetty /dev/tty2
root      2149  0.0  0.0   4060   544 tty3     Ss+  17:41   0:00 /sbin/mingetty /dev/tty3
root      2153  0.0  0.0   4060   544 tty4     Ss+  17:41   0:00 /sbin/mingetty /dev/tty4
root      2155  0.0  0.0   4060   544 tty5     Ss+  17:41   0:00 /sbin/mingetty /dev/tty5
root      2157  0.0  0.0   4060   544 tty6     Ss+  17:41   0:00 /sbin/mingetty /dev/tty6
root      2189  0.0  1.9 210292 37136 tty1     Ssl+ 17:41   0:02 /usr/bin/Xorg :0 -br -verbose -audit 4 -auth /var/run/gdm/auth-for-gdm-0rww2r/database -nolisten tcp vt1
[root@localhost ~]# 
打开/etc/init/start-ttys.conf 将[1-6] 修改成为[1-2]重启服务器即可

4) 对TCP/IP网络参数调整
调整TCP/IP网络参数，可以加强对抗SYN Flood的能力
echo 'net.ipv4.tcp_syncookie = 1'>>/etc/sysctl.conf
sysctl -p

5) 修改shell命令的history记录行数[默认是1000条]
vi /etc/profile 文件，关注HISTSIZE=1000；
将其设为100,有些公司为了安全设为0，看不到history
不用重启也可以生效 
$source /etc/profile

6) 定时矫正服务器时间
$yum install ntp
crontab -e
加入一行
*/5 * * * * /use/sbin/ntpdate  ntp.api.bz

使用dig 可以找到对应的IP
$dig ntp.api.bz

7) 停止ipv6服务
[root@localhost ~]# lsmod |grep ipv6
nf_conntrack_ipv6       7985  3 
nf_defrag_ipv6         26468  1 nf_conntrack_ipv6
nf_conntrack           79601  3 nf_conntrack_ipv4,nf_conntrack_ipv6,xt_state
ipv6                  336944  32 cnic,ip6t_REJECT,nf_conntrack_ipv6,nf_defrag_ipv6,ib_ipoib,ib_addr

有些网络应用还支持ipv6，禁用可以加强安全，并提高系统性能
通过
ifconfig -a
列出全部接口信息
[root@localhost ~]# ifconfig -a
eth0      Link encap:Ethernet  HWaddr 08:00:27:5A:FA:A0  
          inet addr:10.0.2.15  Bcast:10.0.2.255  Mask:255.255.255.0
          inet6 addr: fe80::a00:27ff:fe5a:faa0/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:89710 errors:0 dropped:0 overruns:0 frame:0
          TX packets:37724 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:95621024 (91.1 MiB)  TX bytes:2270264 (2.1 MiB)

eth1      Link encap:Ethernet  HWaddr 08:00:27:CB:51:6F  
          inet addr:192.168.56.20  Bcast:192.168.56.255  Mask:255.255.255.0
          inet6 addr: fe80::a00:27ff:fecb:516f/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:1299 errors:0 dropped:0 overruns:0 frame:0
          TX packets:233 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:129974 (126.9 KiB)  TX bytes:65976 (64.4 KiB)

lo        Link encap:Local Loopback  
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:12 errors:0 dropped:0 overruns:0 frame:0
          TX packets:12 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:720 (720.0 b)  TX bytes:720 (720.0 b)

ipv6是开启状态，通过修改配置停止ipv6
echo "install ipv6 /bin/true" >/etc/modprobe.d/disable-ipv6.conf
#每当系统需要加载ipv6模块时，强制执行/bin/true来替代实际的模块
echo "IPV6INIT=no" >> /etc/sysconfig/network-scripts/ifconfig-eth0
#禁用基于ipv6的网络，使之不会触发启动

8) 调整Linux 打开的最大文件数
要调整下Liunx打开的文件数，否则运行squid服务在机器上高负载时执行能将很差，另外在Linux部署应用时，遇上
“Too manay open files”这样的问题，这个值也影响服务器最大并发数，Linux是有文件句柄限制的，但默认值不高1024
生产环境服务器很容易达到这个值
打开/etc/security/limit.conf文件，在最后追加以下命令
* soft nofile 65535
* hard nofile 65535
还需要在系统的/etc/rc.local文件里添加以下内容
ulimit -SHn 65535
另外 ulimit -n命令并不能看到文件的最大打开数，可用以下脚本看

#!/bin/bash
for pid in `ps aux | grep nginx |grep -v grep |awk '{print $2}'`
do
    cat /proc/${pid}/limits |grep 'Max open files'
done

9） 启动网卡
网卡配置文件/etc/sysconfig/network-scripts/ifconfig-eth0
ONBOOT=yes
在添加其它网络参数IP NETMASK GATEWAY DNS 

10) 关闭磁盘IO功能
Linux文件默认三个时间
atime  对该文件的访问时间
ctime  此文件inode发生改变时间[元数据]
mtime  此文件修改时间

如果有很多小文件(web服务器上很多小图片)通常是没有必要记录访问时间的，这样就可以减少磁盘I/O
怎样修改呢？
修改系统配置文件/etc/fstab  在包含大量小文件的分区中使用noatime和nodiratime
/dev/sda5 /data/pics exet3 noatime,nodiratime 0 0
这样文件被访问就不会产生写磁盘IO了

11) 修ssh登录设置，禁用root远程登录
SSH服务的优化，前提系统至少有一个sudo权限用户，

sed -i 's@#PermitRootLogin yes@PermitRootLogin no@' /etc/ssh/sshd_config 禁用root登录
sed -i 's@#PermitEmptyPaasswords no@PermitEmptyPasswords no@' /etc/ssh/sshd_config 禁止空密码
sed -i 's@#UserDNS yes@UserDNS no' /etc/ssh/sshd_config  关闭SSH反向查询，加快SSH访问速度

12) 增加具有sudo权限的用户
vi /etc/sudoers
#Allow root to run any commands anywhere
root   ALL=(ALL)    ALL
添加
admin   ALL=(ALL)   ALL
如果在sudo的时候不需要输入密码，可以修改
admin  ALL=(ALL) NOPASSWD:ALL

13) 修改单用户最大进程数，防止fork boomb
清单1. bash 中的 fork 炸弹1.(){ .|.& };.

一旦运行清单 1 给出的 fork 炸弹，会以2的指数次幂的速度不断产生新进程，这会导致系统资源会被迅速耗光，最终除非重新启动机器，否则基本上就毫无办法了。为了防止这会造成太大的损害，我们可以使用 ulimit 限制每个用户能够创建的进程数，如清单 4 所示。

清单4. 限制用户可以创建的进程数
[root@localhost ~]# ulimit -u 128
[root@localhost ~]# ulimit -a
core file size          (blocks, -c) 0
data seg size           (kbytes, -d) unlimited
max nice                        (-e) 20
file size               (blocks, -f) unlimited
pending signals                 (-i) unlimited
max locked memory       (kbytes, -l) unlimited
max memory size         (kbytes, -m) unlimited
open files                      (-n) 1024
pipe size            (512 bytes, -p) 8
POSIX message queues     (bytes, -q) unlimited
max rt priority                 (-r) unlimited
stack size              (kbytes, -s) 8192
cpu time               (seconds, -t) unlimited
max user processes              (-u) 128
virtual memory          (kbytes, -v) unlimited
file locks                      (-x) unlimited
[root@localhost ~]# .() { .|.& } ; .
[1] 6152
[root@localhost ~]# bash: fork: Resource temporarily unavailable
bash: fork: Resource temporarily unavailable
bash: fork: Resource temporarily unavailable
在清单 4 中，我们将用户可以创建的最大进程数限制为 128，执行 fork 炸弹会迅速 fork 出大量进程，此后会由于资源不足而无法继续执行。

fork 炸弹让我们认识到了递归函数的强大功能，同时也意识到一旦使用不当，递归函数所造成的破坏将是巨大的。实际上，fork 炸弹只是一个非常简单的递归函数，它并不涉及参数传递、返回值等问题，而这些问题在使用 bash 编程时是否有完善的支持呢？下面让我们通过几个例子来逐一介绍在 bash 中编写递归函数时应该注意的相关问题。
https://www.ibm.com/developerworks/cn/linux/l-cn-bashrecur/

系统默认ulimit -a
[root@localhost ~]# limit -a
-bash: limit: command not found
[root@localhost ~]# ulimit -a
core file size          (blocks, -c) 0
data seg size           (kbytes, -d) unlimited
scheduling priority             (-e) 0
file size               (blocks, -f) unlimited
pending signals                 (-i) 7399
max locked memory       (kbytes, -l) 64
max memory size         (kbytes, -m) unlimited
open files                      (-n) 1024
pipe size            (512 bytes, -p) 8
POSIX message queues     (bytes, -q) 819200
real-time priority              (-r) 0
stack size              (kbytes, -s) 10240
cpu time               (seconds, -t) unlimited
max user processes              (-u) 7399
virtual memory          (kbytes, -v) unlimited
file locks                      (-x) unlimited
[root@localhost ~]# 

默认max user processes过大
```

1.4.2 优化linux下内核TCP参数，提高系统性能
---

```txt
内核优化跟服务器优化一样，本着稳定安全的原则，

```
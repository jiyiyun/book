8.1.1 LVS负载均衡简介
===

LVS(Linux Virtual Server)

8.1.2 基于NAT的LVS负载均衡
---

NAT(Network Address Translation)即网络地址转换，通过修改数据包报头，使企业内部私有的IP可以访问外网。外部用户可以访问内部私网，LVS负载均衡器使用两块网卡配置不同的IP地址，eth0设置为私钥IP与内部网络通过交换设备相互连接，eth1设置为外网IP与外部网络联通。

```txt
Web1 192.168.0.11---|
                    |         eth0 192.168.0.254
Web2 192.168.0.12---|--Swich--LVS负载均衡调度器----Internet---互联网用户
                    |         eth1 124.126.147.168
Web3 192.168.0.13---|
```
第一步：用户通过DNS解析到负载均衡设备上的公网IP地址，相对于真实服务器而言，LVS的外网IP称为VIP(Virtual Address)用户通过访问VIP即可连接后端服务器。

第二步：用户将请求发送到负载均衡调度器，LVS通过算法选择后真实端服务器，将请求发送给该真实服务器，在转发之前LVS会修改数据包中的目标地址和目标端口，目标地址为真实服务器地址，端口改为真实服务器相应的端口

第三步：真实服务器将相应数据包返回给LVS调度器，调度器将收到的相应数据包修改源地址为VIP地址，端口改为相应的端口，修改完成后将数据包发送回终端用户。另外由于LVS调度器有个连接hash表，该表记录连接请求及转发信息，当同一个连接下一次连接的时候，从该hash表中可以直接找到以前的连接记录，并根据记录选出相同的真实服务器及端口信息。

8.1.3 基于TUN的LVS负载均衡
---

LVS(NAT)模式如果后端服务器数量大于10台，调度器就会成为瓶颈，LVS(TUN)思路就是将请求和响应数据分离，让调度器仅处理数据请求，而让真实服务器将响应数据包直接发送给客户端，IP隧道(IP Tunning)是一种数据包封装技术，将原始请求数据包封装并添加新的报头(内容包括新的源地址及端口，目标地址及端口)，从而实现将一个目标为调度器VIP地址的数据包封装，通过隧道转发给后端真实服务器(Real Server)

通过将客户端发往调度器的原始数据包封装，加上新的数据包头(修改目标地址为调度器出来的真实服务器地址及对应端口)，并在其基础上添加新的数据包头(修改目标地址为调度器选择出来的真实服务器IP及对应端口)，LVS(TUN)模式要求真实服务器可以直接与外部网络连接，真实服务器收到请求数据包后直接给客户端主机响应数据
```txt
----------------Internet-----------------------------------|
|                                                          |
|---Web1 124.126.147.111---|                            互联网用户
|                          |                               |
|                          |                               |
|---Web2 124.126.147.112---|--IP隧道---LVS负载均衡调度器----Internet
|                          |           VIP 124.126.147.168
|                          |                               
|---Web3 124.126.147.113---|
```
8.1.4 基于DR的LVS负载均衡
---

在TUN模式下，由于LVS和真实服务器之间通过隧道连接，会增加LVS调度器负担，与TUN模式类似，DR模式叫直接路由模式，DR模式LVS服务器依然承担数据入站请求以及根据算法选出合理真实服务器，最后后端真实服务器负责响应数据包直接发送给客户端，与隧道模式不同的是，DR模式要求LVS调度器必须和真实服务器在同一个局域网，VIP地址需要在调度器与后端所有真实服务器间共享，最终真实服务器给客户端响应数据包需要设置源IP为VIP地址。目的地址为客户端IP。客户端访问的是调度器的VIP地址，回应的源地址依然是该VIP地址(真实服务器的VIP)，客户端感受不到真实服务器存在。

由于多台服务器设置了相同的VIP，所以DR模式中要求调度器的VIP地址对外不可见。所有的真实服务器的VIP必须配置在Non_ARP的网络设备上，就是该网络设备不会广播直接的MAC地址和IP地址，真实服务器的VIP对外不可见，但是真实服务器可以接收目标地址为VIP的网络请求，并在回应数据包时将源地址设置为VIP地址，调度器根据算法选出真实服务器后，在不修改报文的情况下，将该帧的MAC地址改为选出来的真实服务器的MAC地址，通过交换机将该帧转发给真实服务器，真实服务器的VIP地址对外不可见

```txt
|------------------Router------------------Internet----------|
|                                                            |
|--Web1 192.168.0.11----|                                  互联网用户
|  VIP 124.126.147.168  |                                    |
|                       |         eth0 VIP 124.126.147.168   |
|--Web1 192.168.0.12----|--Swich--LVS负载均衡调度器---------Inernet
|  VIP 124.126.147.168  |         eth1 192.168.0.254
|                       |
|--Web1 192.168.0.13    |
|  VIP 124.126.147.168  |
```
8.1.5 负载均衡算法
---

主要8种
- 轮询 RR
- 加权轮询 WRR
- 最小连接 LC    #把请求调度到连接数量最小的服务器上
- 加权最小连接 WLC
- 基于局部性最少连接 LBLC #根据请求数据包IP地址寻找离该请求最近的服务器
- 带复制的基于局部性最少连接 LBLCR #维护一个目标IP到一组服务器映射关系可以防止单点故障
- 目标地址Hash调度 DH
- 源地址Hash调度 SH
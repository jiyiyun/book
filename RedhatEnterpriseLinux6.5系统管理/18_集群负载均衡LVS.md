18.2.1 三种负载均衡技术
---

```txt
Virtual Server via Network Address Translation(VS/NAT)
该技术前端负载均衡器通过重写请求报文的目的地址实现网络地址转换，根据设定的负载均衡算法将请求分配给
后端真实服务器real server RS ,真实服务器的相应报文通过负载均衡器时，报文的源地址被重写，然后返回
给客户端

由于NAT的每次请求接受返回都要经过负载均衡器，对前端负载均衡器性能要求比较高，如果业务量大负载均衡器
可能会成为瓶颈


Virtual Server via IP Tunneling(VS/TUN)
NAT模式请求和相应报文都要经过负载均衡器重写，负载均衡器会成为瓶颈，为了解决此问题，负载均衡器把报文
通过隧道转发至真实服务器，而真实服务器将响应直接返回给客户，此种技术负载均衡器只处理请求报文，结果不
需要经过负载均衡器，采用此种技术集群吞吐量更大，同时TUN模式可以支持跨网段，并支持跨地域部署，灵活

Virtual Server via Direct Routing(VS/DR)
该模式通过改写请求报文MAC地址，将请求发送到真实服务器，类似与TUN，DR模式下，真实服务器直接返回给客户端
因此VS/DR技术极大提高系统伸缩性，由于没有IP隧道开销，真实服务器没有必要支持IP隧道协议请求，

```
18.2.2 负载均衡调度算法
---

```txt
轮询Round Robin算法,简称RR
负载均衡器通过轮询调度算法将外部请求按顺序轮流分配到集群中的真实服务器上，每台后端服务器都是平等无差别的
此种算法忽略了真实服务器负载情况，需要和其它监控手段一起用

加权轮询Weighted Round Robin 算法,简称WRR
负载均衡器通过加权轮询调度算法根据真实服务器的不同处理能力来调度访问请求，从而使处理能力更强的服务器处理
更多的请求，负载均衡器可以自动询问真实服务器负载情况，动态调取权值，和轮询比有很大的灵活性

最少链接Least Connections算法，简称LC
负载均衡器通过最少连接算法动态将网络请求调度到已建立连接最少的服务器上，如果真实服务器处理能力相近，此种
负载均衡算法还可以较好的均衡负载

加权最少连接Weighted Least Connection算法，简称WLC
在集群服务器性能相差较大的情况下，负载均衡器采用加权最小连接调用算法优化负载均衡功能，具有较高的权值的服务器
将承受较大比例的活动连接负载

基于局部性的最少连接Locality-Based Least Connections算法，简称LBLC
基于局部性最少连接调度算法是针对目标地址的负载均衡，该算法根据IP地址找出离目标IP最近的服务器，如该服务器没有
超载，将请求发送到该服务器，若服务器不存在或者超载，则用最少连接选出一个可用服务器，将请求发送给该服务器

带复制的基于局部性最小连接Locality-Based Least Connections with Replication,简称LBLCR
带复制的基于局部性最少连接调度算法也是针对目标IP地址的负载均衡，它与LBLC不同之处是要维护从一个目标IP地址到
一组服务器的映射，该算法根据请求的目标IP地址找出该目标IP地址对应的服务器组，按最小原则从服务器中选出一台服务器
若没有超载将请求发送给该服务器，若超载，则按照最小连接原则从这个集群中选出一台服务器，将该服务器加入到服务器组
中，将请求发送到该服务器

目标地址散列Destination Hashing算法,简称DH
根据请求的目的IP地址，作为散列键key,从静态分配的散列表中找出对应的服务器，若该服务器可用未超载，将请求发送到
该服务器，否则返回空

源地址散列Source Hashing算法，简称SH
根据请求源地址，作为散列键从静态分配的散列列表中找出对应服务器，若该服务器未超载，将请求发送给该服务器，若超载
返回空
```

18.3 LVS集群体系结构
---

```txt
1 负载均衡器Load Balancer ,简称LB
2 真实服务器池 Real Server Pool 是一组真正执行客户请求的服务器，负责处理客户请求并返回结果
3 共享存储 Shared Storage,可选组成部分，主要提供一个共享的存储区，从而使服务器池拥有相同的内容，提供相同服务
```

18.4 LVS负载均衡配置实例
---

```txt
ipvsadm软件的安装
/sbin/ipvsadm   为LVS主管理程序，负责RS的添加删除修改
ipvsadm-save    备份LVS配置
ipvsadm-restore 恢复LVS配置

常用参数
参数    说明
-A     在内核的虚拟服务器列表中添加一条新的虚拟服务器记录
-a     在内核虚拟服务器列表的一条记录中添加一条真实服务器记录

-E     编辑内核虚拟服务器表中一条虚拟服务器记录
-e     编辑一条虚拟服务器记录中某条真实服务器记录

-D     删除内核虚拟服务器列表中某条虚拟服务器记录
-d     删除内核虚拟服务器列表中某条真实服务器记录

-C     清除内核虚拟服务器列表中所有记录
-R     恢复虚拟服务器规则
-S     保存虚拟服务器规则，输出为-R 选项可读的格式

-L|l   显示内核虚拟服务器表
-Z     虚拟服务器计数清零(清空当前连接数等)

-t    说明虚拟服务器提供的是tcp服务
-u    说明虚拟服务器提供的是udp服务

-f    说明是经过iptables标记的服务类型
-p    持久服务
-r    真实的服务器
-s    使用的调度算法,常见选项 rr|wrr|lc|wlc|lblc|lblcr|dh|sh|sed|nq

-g   指定LVS工作模式是直接路由模式
-i   指定LVS工作模式是隧道模式
-m   指定LVS工作模式是NAT模式

-w   真实服务器的权值
-c   显示LVS目前连接数
-n   输出IP地址和端口的数字形式


NAT模式配置
1)启用路由转发功能
echo "1" >/proc/sys/net/ipv4/ip_forward
2)清除ipvsadm表
ipvsadm -C
3)安装LVS服务
/sbin/ipvsadm -A -t 192.168.32.150:80
4)添加第一台real server
/sbin/ipvsadm -a -t 192.168.32.150:80 -r 192.168.32.10:80 -m -w 1
第二台
/sbin/ipvsadm -a -t 192.168.32.150:80 -r 192.168.32.20:80 -m -w 1
真实服务器权重设为1

DR模式配置
前提安装ipvsadm软件
1)启用路由转发功能
echo "1" >/proc/sys/net/ipv4/ip_forward
2)清除ipvsadm表
ipvsadm -C
3)安装LVS服务
/sbin/ipvsadm -A -t 192.168.32.150:80
4)添加第一台real server
/sbin/ipvsadm -a -t 192.168.32.150:80 -r 192.168.32.10:80 -g -w 1
第二台
/sbin/ipvsadm -a -t 192.168.32.150:80 -r 192.168.32.20:80 -g -w 1
真实服务器权重设为1

基于IP隧道模式
1)启用路由转发功能
echo "1" >/proc/sys/net/ipv4/ip_forward
2)清除ipvsadm表
ipvsadm -C
3)安装LVS服务
/sbin/ipvsadm -A -t 192.168.32.150:80
4)添加第一台real server
/sbin/ipvsadm -a -t 192.168.32.150:80 -r 192.168.32.10:80 -i -w 1
第二台
/sbin/ipvsadm -a -t 192.168.32.150:80 -r 192.168.32.20:80 -i -w 1
设置真实服务器权重为1

```
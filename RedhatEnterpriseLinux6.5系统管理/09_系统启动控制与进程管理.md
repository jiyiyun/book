9.1 系统启动管理
---

```txt
windows下系统启动引导管理器为NTLOADER
GRUB是多操作系统启动程序，	GRUB用于选择操作系统分区上的不同内核，同时通过特定设置可以向内核传递启动参数

[root@localhost ~]# cat -n /boot/grub/grub.conf
     1  # grub.conf generated by anaconda
     2  #
     3  # Note that you do not have to rerun grub after making changes to this file
     4  # NOTICE:  You have a /boot partition.  This means that
     5  #          all kernel and initrd paths are relative to /boot/, eg.
     6  #          root (hd0,0)
     7  #          kernel /vmlinuz-version ro root=/dev/mapper/vg_centos-lv_root
     8  #          initrd /initrd-[generic-]version.img
     9  #boot=/dev/sda
    10  default=0
    11  timeout=5
    12  splashimage=(hd0,0)/grub/splash.xpm.gz
    13  hiddenmenu
    14  title CentOS Linux 6 (2.6.32-754.el6.x86_64)
    15          root (hd0,0)
    16          kernel /vmlinuz-2.6.32-754.el6.x86_64 ro root=/dev/mapper/vg_centos-lv_root rd_NO_LUKS LANG=en_US.UTF-8 rd_LVM_LV=vg_centos/lv_swap rd_NO_MD SYSFONT=latarcyrheb-sun16 crashkernel=128M rd_LVM_LV=vg_centos/lv_root  KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM rhgb quiet
    17          initrd /initramfs-2.6.32-754.el6.x86_64.img

第一行 default=0  如果有多个引导选项，系统启动时默认选择的条目，编号从0开始
第二行 timeout=5  GRUB引导菜单等待时间
第三行 指定GRUB在引导时所使用的屏幕图像位置
第四行 这个命令被使用时，系统引导时不显示GRUB菜单接口，在超时时间过期后载入默认选项，按esc可以看到标准的GRUB菜单
第五行 title设置GRUB菜单中显示的选项
第六行 系统文件位于第一块硬盘第一个区
第七行 内核文件所在路径
第八行 initrd 是initial ramdisk的缩写，initrd一般用来临时引导硬件到实际内核vmlinuz能够接管并继续引导的状态，initrd映像中包含了支持linux系统两阶段引导过程所需要的必要可执行程序和系统文件，比如驱动等

9.1.2 linux系统启动过程
BIOS
GRUB引导
内核启动
Init   [rc.sysinit ,rc] 
mingetty
shell
具体步骤
1)开机自检
2)从硬盘的MBR读取引导程序LILO 或GRUB
3)引导程序根据配置文件显示引导菜单
4)如果选择进入Linux系统，引导程序加载linux内核文件
5)当内核全部载入内存后，GRUB的任务完成，此时全部控制权交给Linux,CPU开始执行Linux内核代码，如：初始化任务调度，分配内存，加载驱动等
6)内核代码执行完后，开始执行linux第一个进程,init进程，进程号1
7)init进程根据系统初始化配置文件/etc/inittab文件，执行相应的系统初始化脚本
8)根据/etc/inittab文件配置，进入不同的运行级别
9)启动或停止相应运行级别下的服务
10)建立终端
11)引导login进程，进入登录界面

系统运行级别
0 停机
1 单用户模式
2 多用户，但没有网络文件系统
3 完全多用户模式
4 未用保留
5 x11 ，图形界面接口
6 重新启动

[root@localhost ~]# runlevel
N 5


[root@localhost ~]# cat /etc/inittab
# inittab is only used by upstart for the default runlevel.
#
# ADDING OTHER CONFIGURATION HERE WILL HAVE NO EFFECT ON YOUR SYSTEM.
#
# System initialization is started by /etc/init/rcS.conf
#
# Individual runlevels are started by /etc/init/rc.conf
#
# Ctrl-Alt-Delete is handled by /etc/init/control-alt-delete.conf
#
# Terminal gettys are handled by /etc/init/tty.conf and /etc/init/serial.conf,
# with configuration in /etc/sysconfig/init.
#
# For information on how to write upstart event handlers, or how
# upstart works, see init(5), init(8), and initctl(8).
#
# Default runlevel. The runlevels used are:
#   0 - halt (Do NOT set initdefault to this)
#   1 - Single user mode
#   2 - Multiuser, without NFS (The same as 3, if you do not have networking)
#   3 - Full multiuser mode
#   4 - unused
#   5 - X11
#   6 - reboot (Do NOT set initdefault to this)
#
id:5:initdefault:

要开机进入文本界面，将5改成3即可

[root@localhost ~]# cat /etc/rc
rc          rc1.d/      rc3.d/      rc5.d/      rc.d/       rc.sysinit
rc0.d/      rc2.d/      rc4.d/      rc6.d/      rc.local
[root@localhost ~]# ls /etc/rc3.d/
K01smartd          K73winbind         K92pppoe-server  S13iscsi             S26udev-post
K02oddjobd         K74ipsec           K95firstboot     S13rpcbind           S27pcscd
K05wdaemon         K74nscd            K99rngd          S15mdmonitor         S28autofs
K10psacct          K74ntpd            S00livesys       S20lldpad            S50bluetooth
K10saslauthd       K75ntpdate         S01sysstat       S21fcoe              S50kdump
K15htcacheclean    K75quota_nld       S02lvm2-monitor  S22messagebus        S80postfix
K15httpd           K76ypbind          S05rdma          S23NetworkManager    S82abrtd
K25sshd            K84wpa_supplicant  S07iscsid        S24nfslock           S83abrt-ccpp
K30spice-vdagentd  K87multipathd      S08ip6tables     S24openct            S90crond
K35vncserver       K87restorecond     S08iptables      S24rpcgssd           S95atd
K36mysqld          K88nslcd           S11auditd        S25blk-availability  S99certmonger
K50dnsmasq         K88sssd            S11portreserve   S25cups              S99livesys-late
K60nfs             K89netconsole      S12rsyslog       S25netfs             S99local
K61nfs-rdma        K89rdisc           S13cpuspeed      S26acpid
K69rpcsvcgssd      K90network         S13irqbalance    S26haldaemon

#shutdown -t3 -r now   重启系统
```

9.1.5系统启动服务控制
---

```txt
在linux系统中，服务的初始化脚本一般保存在/etc/rc.d/init.d符号链接为/etc/init.d中，通常用start启动，stop停止服务

使用chkconfig命令查看各个服务在各运行级别的情况
[root@localhost ~]# chkconfig --list
NetworkManager  0:off   1:off   2:on    3:on    4:on    5:on    6:off
autofs          0:off   1:off   2:off   3:on    4:on    5:on    6:off
httpd           0:off   1:off   2:off   3:off   4:off   5:off   6:off
ip6tables       0:off   1:off   2:on    3:on    4:on    5:on    6:off
ipsec           0:off   1:off   2:off   3:off   4:off   5:off   6:off
iptables        0:off   1:off   2:on    3:on    4:on    5:on    6:off
mysqld          0:off   1:off   2:off   3:off   4:off   5:off   6:off
netconsole      0:off   1:off   2:off   3:off   4:off   5:off   6:off
netfs           0:off   1:off   2:off   3:on    4:on    5:on    6:off
network         0:off   1:off   2:off   3:off   4:off   5:off   6:off
nfs             0:off   1:off   2:off   3:off   4:off   5:off   6:off
nfs-rdma        0:off   1:off   2:off   3:off   4:off   5:off   6:off
nfslock         0:off   1:off   2:off   3:on    4:on    5:on    6:off
ntpd            0:off   1:off   2:off   3:off   4:off   5:off   6:off
sshd            0:off   1:off   2:off   3:off   4:off   5:off   6:off
sssd            0:off   1:off   2:off   3:off   4:off   5:off   6:off
vncserver       0:off   1:off   2:off   3:off   4:off   5:off   6:off


[root@localhost ~]# chkconfig --list mysqld
mysqld          0:off   1:off   2:off   3:off   4:off   5:off   6:off

除了已经存在的服务以外，可以手动将新的启动脚本加入到系统服务中，
[root@localhost ~]# cat -n /etc/init.d/httpd
     1  #!/bin/bash
     2  #
     3  # httpd        Startup script for the Apache HTTP Server
     4  #
     5  # chkconfig: - 85 15
     6  # description: The Apache HTTP Server is an efficient and extensible  \
     7  #              server implementing the current HTTP standards.
     8  # processname: httpd
     9  # config: /etc/httpd/conf/httpd.conf
    10  # config: /etc/sysconfig/httpd
    11  # pidfile: /var/run/httpd/httpd.pid
    12  #
    13  ### BEGIN INIT INFO
    14  # Provides: httpd
    15  # Required-Start: $local_fs $remote_fs $network $named
    16  # Required-Stop: $local_fs $remote_fs $network
    17  # Should-Start: distcache
    18  # Short-Description: start and stop Apache HTTP Server
    19  # Description: The Apache HTTP Server is an extensible server
    20  #  implementing the current HTTP standards.
    21  ### END INIT INFO
    22
    23  # Source function library.
    24  . /etc/rc.d/init.d/functions
    25
    26  if [ -f /etc/sysconfig/httpd ]; then
    27          . /etc/sysconfig/httpd
    28  fi
    29
    30  # Start httpd in the C locale by default.
    31  HTTPD_LANG=${HTTPD_LANG-"C"}
    32
    33  # This will prevent initlog from swallowing up a pass-phrase prompt if
    34  # mod_ssl needs a pass-phrase from the user.
    35  INITLOG_ARGS=""
    36
    37  # Set HTTPD=/usr/sbin/httpd.worker in /etc/sysconfig/httpd to use a server
    38  # with the thread-based "worker" MPM; BE WARNED that some modules may not
    39  # work correctly with a thread-based MPM; notably PHP will refuse to start.
    40
    41  # Path to the apachectl script, server binary, and short-form for messages.
    42  apachectl=/usr/sbin/apachectl
    43  httpd=${HTTPD-/usr/sbin/httpd}
    44  prog=httpd
    45  pidfile=${PIDFILE-/var/run/httpd/httpd.pid}
    46  lockfile=${LOCKFILE-/var/lock/subsys/httpd}
    47  RETVAL=0
    48  STOP_TIMEOUT=${STOP_TIMEOUT-10}
    49
    50  # The semantics of these two functions differ from the way apachectl does
    51  # things -- attempting to start while running is a failure, and shutdown
    52  # when not running is also a failure.  So we just do it the way init scripts
    53  # are expected to behave here.
    54  start() {
    55          echo -n $"Starting $prog: "
    56          LANG=$HTTPD_LANG daemon --pidfile=${pidfile} $httpd $OPTIONS
    57          RETVAL=$?
    58          echo
    59          [ $RETVAL = 0 ] && touch ${lockfile}
    60          return $RETVAL
    61  }
    62
    63  # When stopping httpd, a delay (of default 10 second) is required
    64  # before SIGKILLing the httpd parent; this gives enough time for the
    65  # httpd parent to SIGKILL any errant children.
    66  stop() {
    67          status -p ${pidfile} $httpd > /dev/null
    68          if [[ $? = 0 ]]; then
    69                  echo -n $"Stopping $prog: "
    70                  killproc -p ${pidfile} -d ${STOP_TIMEOUT} $httpd
    71          else
    72                  echo -n $"Stopping $prog: "
    73                  success
    74          fi
    75          RETVAL=$?
    76          echo
    77          [ $RETVAL = 0 ] && rm -f ${lockfile} ${pidfile}
    78  }
    79
    80  reload() {
    81      echo -n $"Reloading $prog: "
    82      if ! LANG=$HTTPD_LANG $httpd $OPTIONS -t >&/dev/null; then
    83          RETVAL=6
    84          echo $"not reloading due to configuration syntax error"
    85          failure $"not reloading $httpd due to configuration syntax error"
    86      else
    87          # Force LSB behaviour from killproc
    88          LSB=1 killproc -p ${pidfile} $httpd -HUP
    89          RETVAL=$?
    90          if [ $RETVAL -eq 7 ]; then
    91              failure $"httpd shutdown"
    92          fi
    93      fi
    94      echo
    95  }
    96
    97  # See how we were called.
    98  case "$1" in
    99    start)
   100          start
   101          ;;
   102    stop)
   103          stop
   104          ;;
   105    status)
   106          status -p ${pidfile} $httpd
   107          RETVAL=$?
   108          ;;
   109    restart)
   110          stop
   111          start
   112          ;;
   113    condrestart|try-restart)
   114          if status -p ${pidfile} $httpd >&/dev/null; then
   115                  stop
   116                  start
   117          fi
   118          ;;
   119    force-reload|reload)
   120          reload
   121          ;;
   122    graceful|help|configtest|fullstatus)
   123          $apachectl $@
   124          RETVAL=$?
   125          ;;
   126    *)
   127          echo $"Usage: $prog {start|stop|restart|condrestart|try-restart|force-reload|reload|status|fullstatus|graceful|help|configtest}"
   128          RETVAL=2
   129  esac
   130
   131  exit $RETVAL
[root@localhost ~]#

2)设置文件权限并添加到系统服务
[root@localhost ~]# chkconfig --list sshd
sshd            0:off   1:off   2:off   3:off   4:off   5:off   6:off
[root@localhost ~]# chkconfig --add sshd
[root@localhost ~]# chkconfig --list sshd
sshd            0:off   1:off   2:off   3:off   4:off   5:off   6:off
[root@localhost ~]# chkconfig --list httpd
httpd           0:off   1:off   2:off   3:off   4:off   5:off   6:off
[root@localhost ~]# chkconfig --add httpd
[root@localhost ~]# chkconfig --list httpd
httpd           0:off   1:off   2:off   3:off   4:off   5:off   6:off

3)设置每个级别的启动方式，经过次步，系统会在/etc/rcN.d目录下面创建http文件的软链接，以便系统启动的时候启动
[root@localhost ~]# service httpd status
httpd is stopped
[root@localhost ~]# service sshd status
openssh-daemon (pid  3002) is running...
[root@localhost ~]# chkconfig --level 1245 http off
error reading information on service http: No such file or directory
[root@localhost ~]# chkconfig --level 1245 httpd off
[root@localhost ~]# chkconfig --list httpd
httpd           0:off   1:off   2:off   3:off   4:off   5:off   6:off
[root@localhost ~]# chkconfig --level 3 httpd on
[root@localhost ~]# chkconfig --list httpd
httpd           0:off   1:off   2:off   3:on    4:off   5:off   6:off
[root@localhost ~]# ls -l /etc/rc3.d/ |grep httpd
lrwxrwxrwx. 1 root root 15 Jan 15 19:48 S85httpd -> ../init.d/httpd

[root@localhost ~]# service httpd start
Starting httpd:                                            [  OK  ]
[root@localhost ~]# service httpd stop
Stopping httpd:                                            [  OK  ]

```

9.2 Linux进程管理
---

```txt
进程是系统资源分配的单位，当程序运行后进程便会产生，一个程序可能有多个进程

1)进程的分类
交互进程，批处理进程，守护进程
守护进程一般在后台运行，可以开机启动通过脚本激活启动或手动启动放在后台运行

2) 进程属性
进程ID  (PID) 是唯一的数值，用来区分进程
父进程和父进程的ID  (PPID)
启动进程的用户ID(UID)和归属组ID(GID)
进程状态 运行R 休眠S 僵尸Z
进程执行的优先级；进程所连接的终端名
进程资源占用：比如进程占用资源大小(内存，CPU占用量)

3)父进程和子进程
两者关系是管理和被管理关系，当父进程终止时，子进程也随之终止，但子进程终止父进程并不一定终止，当进程运行中，某一进程占用资源过多或无法控制某一进程时，该进程应kill，以保护系统文档安全运行

```

9.2.2 进程管理常用命令ps top tree kill nice renice
---

```txt
1)进程监视ps
ps提供了一次性查看，并不是动态的，动态的可以使用top命令

ps命令常用参数
l 长格式输出
u  按用户名和启动时间顺序来显示进程
a  显示所有用户进程，
f  列出进程全部相关信息，通常和其它选项联用
r  显示运行中的进程
x  显示无控制端的进程
w  避免详细参数被截断
j  任务格式来显示进程

[root@localhost ~]# ps -aux |head
Warning: bad syntax, perhaps a bogus '-'? See /usr/share/doc/procps-3.2.8/FAQ
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root         1  0.1  0.0  19364  1556 ?        Ss   19:50   0:01 /sbin/init
root         2  0.0  0.0      0     0 ?        S    19:50   0:00 [kthreadd]
root         3  0.0  0.0      0     0 ?        S    19:50   0:00 [migration/0]
root         4  0.0  0.0      0     0 ?        S    19:50   0:00 [ksoftirqd/0]
root         5  0.0  0.0      0     0 ?        S    19:50   0:00 [stopper/0]
root         6  0.0  0.0      0     0 ?        S    19:50   0:00 [watchdog/0]
root         7  0.0  0.0      0     0 ?        S    19:50   0:00 [migration/1]
root         8  0.0  0.0      0     0 ?        S    19:50   0:00 [stopper/1]
root         9  0.0  0.0      0     0 ?        S    19:50   0:00 [ksoftirqd/1]
[root@localhost ~]# ps -ef |head
UID        PID  PPID  C STIME TTY          TIME CMD
root         1     0  0 19:50 ?        00:00:01 /sbin/init
root         2     0  0 19:50 ?        00:00:00 [kthreadd]
root         3     2  0 19:50 ?        00:00:00 [migration/0]
root         4     2  0 19:50 ?        00:00:00 [ksoftirqd/0]
root         5     2  0 19:50 ?        00:00:00 [stopper/0]
root         6     2  0 19:50 ?        00:00:00 [watchdog/0]
root         7     2  0 19:50 ?        00:00:00 [migration/1]
root         8     2  0 19:50 ?        00:00:00 [stopper/1]
root         9     2  0 19:50 ?        00:00:00 [ksoftirqd/1]

[root@localhost ~]# service httpd start
Starting httpd:                                            [  OK  ]
[root@localhost ~]# ps -ef |grep httpd |head
root      3061     1  0 20:13 ?        00:00:00 /usr/sbin/httpd
apache    3064  3061  0 20:13 ?        00:00:00 /usr/sbin/httpd
apache    3065  3061  0 20:13 ?        00:00:00 /usr/sbin/httpd
apache    3066  3061  0 20:13 ?        00:00:00 /usr/sbin/httpd
apache    3067  3061  0 20:13 ?        00:00:00 /usr/sbin/httpd
apache    3068  3061  0 20:13 ?        00:00:00 /usr/sbin/httpd
apache    3069  3061  0 20:13 ?        00:00:00 /usr/sbin/httpd
apache    3070  3061  0 20:13 ?        00:00:00 /usr/sbin/httpd
apache    3071  3061  0 20:13 ?        00:00:00 /usr/sbin/httpd
root      3073  2861  0 20:13 pts/1    00:00:00 grep httpd
[root@localhost ~]#

ps命令参数说明
USER 启动进程的用户
PID 进程号
%CPU  进程占用CPU百分比
%MEM  进程使用内存百分比
VSZ   进程使用虚拟内存总量，单位K
RSS   进程使用的，未被换出的物理内存大小，单位KB
TTY   终端ID
STAT  进程状态
START 进程启动时间
TIME  进程消耗的CPU时间
COMMAND  启动命令的名称和参数

STAT 表示进程终止，死掉，或僵尸进程，进程常见状态
D  不能被中断的
R  正在运行队列中可过行的
S  处于休眠状态
T  停止或被追踪
W  进入内存交换，从内核2.6开始无效
X  死掉的进程
Z  僵尸进程


问现在要提取倒数第二行，怎么提取？

```